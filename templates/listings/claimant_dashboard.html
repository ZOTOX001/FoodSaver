{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="h-[calc(100vh-64px)] w-full flex bg-background-light dark:bg-black relative overflow-hidden">

    <!-- 1. Left Map Area (Simplified as requested) -->
    <div class="flex-1 relative bg-[#e5e7eb] dark:bg-[#1f1f1f]">
        <!-- Search, Map, Zoom controls remain same -->
        <div class="absolute top-6 left-6 z-10 w-80">
            <div
                class="flex items-center gap-3 bg-white dark:bg-zinc-800 px-4 py-3 rounded-xl shadow-lg border border-gray-100 dark:border-white/5">
                <span class="material-symbols-outlined text-green-500">search</span>
                <input type="text" placeholder="Search area in Bangalore..."
                    class="w-full bg-transparent border-none p-0 text-sm font-bold focus:ring-0 placeholder-gray-400">
            </div>
        </div>

        <canvas id="foodMap"
            class="absolute inset-0 w-full h-full cursor-pointer focus:outline-none opacity-80"></canvas>

        <div class="absolute bottom-6 right-6 flex flex-col gap-2">
            <button onclick="zoomIn()"
                class="size-10 bg-white dark:bg-zinc-800 shadow-md rounded-lg flex items-center justify-center font-bold text-xl hover:bg-gray-50">+</button>
            <button onclick="zoomOut()"
                class="size-10 bg-white dark:bg-zinc-800 shadow-md rounded-lg flex items-center justify-center font-bold text-xl hover:bg-gray-50">-</button>
        </div>
    </div>

    <!-- 2. Right Sidebar Listings -->
    <div
        class="w-[480px] bg-[#f9fafb] dark:bg-black border-l border-gray-200 dark:border-white/10 flex flex-col z-20 shadow-2xl">
        <div class="p-6 pb-2">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-black dark:text-white">Urgent Listings</h2>
                <div
                    class="px-2 py-0.5 bg-red-100 text-red-600 text-[10px] font-black tracking-widest uppercase rounded flex items-center gap-1">
                    <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span> Live
                </div>
            </div>

            <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                <button
                    class="filter-btn active px-4 py-1.5 bg-[#13ec13] text-black text-xs font-bold rounded shadow-lg shadow-green-200 hover:scale-105 transition-transform"
                    data-filter="all">All</button>
                <button
                    class="filter-btn px-4 py-1.5 bg-white border border-gray-200 text-gray-600 text-xs font-bold rounded hover:border-green-500 transition-colors"
                    data-filter="veg">Veg Only</button>
                <button
                    class="filter-btn px-4 py-1.5 bg-white border border-gray-200 text-gray-600 text-xs font-bold rounded hover:border-green-500 transition-colors"
                    data-filter="non-veg">Non-Veg</button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-4">
            {% for listing in listings %}
            <!-- Card -->
            <div class="listing-card bg-white dark:bg-zinc-900 p-5 rounded-2xl shadow-sm border border-transparent hover:border-green-400 hover:shadow-md transition-all group"
                data-type="{{ listing.food_type }}"
                data-veg="{% if listing.food_type == 'packaged' %}non-veg{% else %}veg{% endif %}">

                <div class="flex justify-between mb-4">
                    <div class="flex gap-4">
                        <!-- Simplified IF logic for classes -->
                        {% if listing.food_type == 'packaged' %}
                        <div class="size-12 rounded-xl bg-red-50 text-red-500 flex items-center justify-center">
                            {% else %}
                            <div class="size-12 rounded-xl bg-green-50 text-green-600 flex items-center justify-center">
                                {% endif %}
                                <span class="material-symbols-outlined">
                                    {% if listing.food_type == 'cooked' %}
                                    restaurant
                                    {% elif listing.food_type == 'raw' %}
                                    grocery
                                    {% else %}
                                    takeout_dining
                                    {% endif %}
                                </span>
                            </div>

                            <div>
                                <h3 class="font-bold text-black dark:text-white text-base leading-tight">
                                    {{ listing.description|truncatechars:25 }}
                                </h3>
                                <p class="text-xs text-gray-400 mt-0.5">
                                    {{ listing.donor.institution_name|default:listing.donor.username }}
                                </p>
                            </div>
                        </div>
                        <span class="text-xs font-bold text-green-600">0.8 km away</span>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-3 gap-2 mb-5">
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Quantity</p>
                            <p class="text-sm font-black text-black dark:text-white">{{ listing.quantity_kg }} kg</p>
                        </div>
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Expires In</p>
                            <p class="text-sm font-black text-orange-500">{{ listing.expiry_time|timeuntil }}</p>
                        </div>
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Rating</p>
                            <div class="flex items-center gap-1">
                                <span class="text-sm font-black text-black dark:text-white">
                                    {{ listing.donor.trust_score|default:"5.0" }}
                                </span>
                                <span class="material-symbols-outlined text-[10px] text-yellow-400">star</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Button -->
                    {% if listing.id in pending_claim_ids %}
                    <button disabled
                        class="block w-full py-3 bg-gray-100 dark:bg-zinc-800 text-gray-400 font-black text-center text-sm rounded-lg cursor-not-allowed">
                        Waiting for Approval
                    </button>
                    {% else %}
                    <a href="{% url 'claim_listing' listing.id %}"
                        class="block w-full py-3 bg-[#13ec13] text-black font-black text-center text-sm rounded-lg hover:brightness-105 active:scale-[0.98] transition-all">
                        Claim Now
                    </a>
                    {% endif %}
                </div>
                {% empty %}
                <div class="text-center py-10 opacity-50">
                    <p>No listings available right now.</p>
                </div>
                {% endfor %}

                <button
                    class="w-full py-4 text-xs font-bold text-gray-400 hover:text-gray-600 uppercase tracking-widest border-t border-gray-100 dark:border-white/5 mt-4">
                    View More Listings
                </button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('foodMap');
        const ctx = canvas.getContext('2d');
        let scale = 1;

        function resize() {
            if (!canvas.parentElement) return;
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = canvas.parentElement.offsetHeight;
            draw();
        }
        window.addEventListener('resize', resize);

        function draw() {
            if (!canvas.width) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#d1d5db';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(0, canvas.height / 2);
            ctx.bezierCurveTo(canvas.width / 3, canvas.height / 3, canvas.width / 1.5, canvas.height / 1.5, canvas.width, canvas.height / 2);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2.5, canvas.height);
            ctx.stroke();

            drawPin(canvas.width / 2 + 40, canvas.height / 2 - 60, '#13ec13');
            drawPin(canvas.width / 3, canvas.height / 1.5, '#ef4444');
            drawPin(canvas.width / 1.5, canvas.height / 3, '#13ec13');
        }

        function drawPin(x, y, color) {
            ctx.beginPath();
            ctx.fillStyle = color;
            ctx.arc(x, y, 15, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = 'white';
            ctx.font = '14px Material Symbols Outlined';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('restaurant', x, y);
        }
        function zoomIn() { scale *= 1.1; draw(); }
        function zoomOut() { scale /= 1.1; draw(); }
        setTimeout(resize, 100);

        const btns = document.querySelectorAll('.filter-btn');
        const cards = document.querySelectorAll('.listing-card');
        btns.forEach(btn => {
            btn.addEventListener('click', () => {
                btns.forEach(b => {
                    b.classList.remove('bg-[#13ec13]', 'text-black', 'shadow-lg', 'shadow-green-200');
                    b.classList.add('bg-white', 'text-gray-600', 'border');
                });
                btn.classList.remove('bg-white', 'text-gray-600', 'border');
                btn.classList.add('bg-[#13ec13]', 'text-black', 'shadow-lg', 'shadow-green-200');

                const filter = btn.dataset.filter;
                cards.forEach(c => {
                    if (filter === 'all') c.style.display = 'block';
                    else c.style.display = (c.dataset.veg === filter) ? 'block' : 'none';
                });
            });
        });
    </script>
    {% endblock %}